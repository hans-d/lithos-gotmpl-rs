---
name: CI

'on':
  push:
    branches:
      - main
      - master
  pull_request:
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  test:
    name: Test Suite
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Install just
        uses: taiki-e/install-action@v2
        with:
          tool: just
      - name: Run unit tests
        run: just ci-test

  behavior:
    name: Behavioral Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go-sanity/go.mod
      - name: Install just
        uses: taiki-e/install-action@v2
        with:
          tool: just
      - name: Behavioral checks
        run: just ci-behavior

  quality:
    name: Code Quality
    runs-on: ubuntu-latest
    env:
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
    steps:
      - uses: actions/checkout@v4
      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.1'
      - uses: Swatinem/rust-cache@v2
      - name: Install just
        uses: taiki-e/install-action@v2
        with:
          tool: just
      - name: Install actionlint
        run: |
          go install github.com/rhysd/actionlint/cmd/actionlint@latest
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH
      - name: Install yamllint
        run: python3 -m pip install --user yamllint
      - name: Code quality checks
        run: just ci-quality
      - name: SonarCloud scan
        if: ${{ env.SONAR_TOKEN != '' }}
        uses: SonarSource/sonarcloud-github-action@v2
        env:
          SONAR_TOKEN: ${{ env.SONAR_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_HOST_URL: ${{ env.SONAR_HOST_URL }}

  security:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Install just
        uses: taiki-e/install-action@v2
        with:
          tool: just
      - name: Install cargo-audit
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-audit
      - name: Install cargo-deny
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-deny
      - name: Security checks
        run: just ci-security
