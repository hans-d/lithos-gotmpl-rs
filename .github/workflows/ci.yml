---
name: CI

permissions:
  contents: read
  pull-requests: read

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

defaults:
  run:
    shell: bash

'on':
  push:
    branches:
      - main
      - master
  pull_request:
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  test:
    name: Test Suite
    timeout-minutes: 30
    runs-on: ubuntu-latest
    steps:
      - uses: step-security/harden-runner@v2.6.1
        with:
          egress-policy: audit
      - uses: actions/checkout@v4.1.6
      - name: Set up Rust
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: stable
      - uses: step-security/rust-cache@v2.8.2
      - name: Install just
        run: |
          if ! command -v just >/dev/null 2>&1; then
            curl -LsSf https://just.systems/install.sh | bash -s -- --to /usr/local/bin
          fi
      - name: Run unit tests
        run: just ci-test

  behavior:
    name: Behavioral Validation
    timeout-minutes: 30
    runs-on: ubuntu-latest
    steps:
      - uses: step-security/harden-runner@v2.6.1
        with:
          egress-policy: audit
      - uses: actions/checkout@v4.1.6
      - name: Set up Rust
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: stable
      - uses: step-security/rust-cache@v2.8.2
      - name: Set up Go
        uses: actions/setup-go@v5.0.1
        with:
          go-version-file: go-sanity/go.mod
          cache: true
          check-latest: true
      - name: Install just
        run: |
          if ! command -v just >/dev/null 2>&1; then
            curl -LsSf https://just.systems/install.sh | bash -s -- --to /usr/local/bin
          fi
      - name: Behavioral checks
        run: just ci-behavior

  quality:
    name: Code Quality
    timeout-minutes: 30
    runs-on: ubuntu-latest
    env:
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
    steps:
      - uses: step-security/harden-runner@v2.6.1
        with:
          egress-policy: audit
      - uses: actions/checkout@v4.1.6
      - name: Set up Rust
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: stable
          components: rustfmt, clippy
      - name: Set up Go
        uses: actions/setup-go@v5.0.1
        with:
          go-version-file: go-sanity/go.mod
          cache: true
          check-latest: true
      - uses: step-security/rust-cache@v2.8.2
      - name: Install just
        run: |
          if ! command -v just >/dev/null 2>&1; then
            curl -LsSf https://just.systems/install.sh | bash -s -- --to /usr/local/bin
          fi
      - name: Install actionlint
        env:
          GOBIN: ${{ runner.temp }}/bin
        run: |
          go install github.com/rhysd/actionlint/cmd/actionlint@latest
          echo "${GOBIN}" >> "$GITHUB_PATH"
      - name: Install yamllint
        run: python3 -m pip install --user yamllint
      - name: Code quality checks
        run: just ci-quality
      - name: SonarCloud scan
        if: ${{ env.SONAR_TOKEN != '' }}
        uses: SonarSource/sonarcloud-github-action@v2.2.0
        env:
          SONAR_TOKEN: ${{ env.SONAR_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_HOST_URL: ${{ env.SONAR_HOST_URL }}

  dependencies:
    name: Dependency Checks
    timeout-minutes: 25
    runs-on: ubuntu-latest
    steps:
      - uses: step-security/harden-runner@v2.6.1
        with:
          egress-policy: audit
      - uses: actions/checkout@v4.1.6
      - name: Set up Rust
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: stable
      - uses: step-security/rust-cache@v2.8.2
      - name: Set up Go
        uses: actions/setup-go@v5.0.1
        with:
          go-version-file: go-sanity/go.mod
          cache: true
          check-latest: true
      - name: Install just & Cargo tools
        run: |
          if ! command -v just >/dev/null 2>&1; then
            curl -LsSf https://just.systems/install.sh | bash -s -- --to /usr/local/bin
          fi
          if ! command -v cargo-audit >/dev/null 2>&1; then
            cargo install --locked cargo-audit
          fi
          if ! command -v cargo-deny >/dev/null 2>&1; then
            cargo install --locked cargo-deny
          fi
      - name: Install go-licenses
        env:
          GOBIN: ${{ runner.temp }}/bin
        run: |
          go install github.com/google/go-licenses/v2@latest
          echo "${GOBIN}" >> "$GITHUB_PATH"
      - name: Dependency review
        if: github.event_name == 'pull_request'
        uses: actions/dependency-review-action@v4.1.3
        with:
          fail-on-severity: high
          allow-licenses: |
            Apache-2.0
            MIT
            BSD-2-Clause
            BSD-3-Clause
            Unicode-DFS-2016
            Unicode-3.0
            BSL-1.0
            LGPL-2.1-or-later
      - name: Dependency checks
        run: just ci-dependencies

  dependencies-full:
    if: github.event_name != 'pull_request'
    name: Dependency Completeness
    timeout-minutes: 35
    runs-on: ubuntu-latest
    steps:
      - uses: step-security/harden-runner@v2.6.1
        with:
          egress-policy: audit
      - uses: actions/checkout@v4.1.6
      - name: Set up Rust
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: stable
      - uses: step-security/rust-cache@v2.8.2
      - name: Set up Go
        uses: actions/setup-go@v5.0.1
        with:
          go-version-file: go-sanity/go.mod
          cache: true
          check-latest: true
      - name: Install just & Cargo tools
        run: |
          if ! command -v just >/dev/null 2>&1; then
            curl -LsSf https://just.systems/install.sh | bash -s -- --to /usr/local/bin
          fi
          if ! command -v cargo-deny >/dev/null 2>&1; then
            cargo install --locked cargo-deny
          fi
          if ! command -v cargo-about >/dev/null 2>&1; then
            cargo install --locked cargo-about
          fi
      - name: Install go-licenses
        env:
          GOBIN: ${{ runner.temp }}/bin
        run: |
          go install github.com/google/go-licenses/v2@latest
          echo "${GOBIN}" >> "$GITHUB_PATH"
      - name: Comprehensive dependency verification
        run: just ci-dependencies-full
